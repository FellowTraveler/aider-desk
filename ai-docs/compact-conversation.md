# Compact Conversation Feature

This document outlines the implementation of the `/compact` command, which allows users to summarize the current conversation context.

## User Story
As a user, I want to be able to summarize the current conversation in the context, so that I can reduce the token count and focus the AI's attention on the most relevant information. I should be able to provide custom instructions to guide the summarization process.

## Command: `/compact [custom instructions]`

- **Purpose**: To summarize the existing conversation in the chat context.
- **Action**: Triggers the `window.api.compactConversation` function call.
- **Arguments**:
    - `mode`: The current project mode ('agent' or 'code').
    - `customInstructions`: (Optional) User-provided text that follows the command, guiding the summarization process.

## Implementation Details

### Shared Behavior (Both Modes)

1.  **Log Message**: Before executing the primary action, a log message "Compacting conversation..." will be displayed in the UI.
    - **File**: `src/renderer/src/components/project/ProjectView.tsx`
    - **Action**: Add a new `LogMessage` to the `messages` state when the compaction process starts.

### UI and Preload Layer

1.  **Command Handling** (`src/renderer/src/components/PromptField.tsx`):
    - Add `/compact` to the list of available commands.
    - In `executeCommand`, add a case for `/compact`.
    - When triggered, it should call `window.api.compactConversation(project.baseDir, args)`, where `args` contains the custom instructions.

2.  **API Definition** (`src/preload/index.d.ts`):
    - Add `compactConversation: (baseDir: string, customInstructions?: string) => void;` to the `window.api` interface.

3.  **API Exposure** (`src/preload/index.ts`):
    - Expose the `compactConversation` function using `ipcRenderer.invoke`.
    - `compactConversation: (baseDir, customInstructions) => ipcRenderer.invoke('compact-conversation', baseDir, customInstructions),`

4.  **Localization** (`src/common/locales/en.json`, `src/common/locales/zh.json`):
    - Add a new key `commands.compact` with the description "Summarize the conversation".

### Main Process

1.  **IPC Handler** (`src/main/session-manager.ts`):
    - Create a new IPC handler for the `'compact-conversation'` channel.
    - `ipcMain.handle('compact-conversation', async (_event, baseDir, customInstructions) => { ... });`
    - The handler should find the corresponding `Project` instance and call `project.compactConversation(customInstructions)`.

2.  **Core Logic** (`src/main/project.ts`):
    - Create a new public method `async compactConversation(customInstructions?: string)`.
    - This method will first send a log message to the renderer: `this.sendLogMessage('info', 'Compacting conversation...');`
    - It will then check the current mode (`this.mode`).

### 'agent' Mode Logic (`src/main/project.ts`)

1.  **Get Current Conversation**: Retrieve the current message history.
2.  **Agent Execution**:
    - Call `this.agent.run(...)` with:
        - `profile`: `COMPACT_CONVERSATION_AGENT_PROFILE`.
        - `prompt`: Generated by `getCompactConversationPrompt(history, customInstructions)`.
3.  **Context Update**:
    - After the agent run completes successfully, clear the existing context: `this.clearContext()`.
    - Add the final message from the agent (the summary) back into the session.

### Agent-Specific Implementation

1.  **Agent Profile** (`src/common/agent.ts`):
    - Define and export `COMPACT_CONVERSATION_AGENT_PROFILE`. It should be a minimal profile, perhaps inheriting the active agent's provider and model but with a specific system prompt for summarization.
    - Example: `export const COMPACT_CONVERSATION_AGENT_PROFILE: AgentProfile = { id: 'compact-conversation', name: 'Compact Conversation', ... };`

2.  **Agent Prompt** (`src/main/agent/prompts.ts`):
    - Create and export `getCompactConversationPrompt(history: Message[], customInstructions?: string): string`.
    - This function will construct a detailed prompt that includes the conversation history and instructs the AI to summarize it, taking the `customInstructions` into account.

### 'code' Mode Logic (`src/main/project.ts`)

1.  **Send to Connector**: If the mode is 'code', call a new method on the connector instance: `this.connector.sendCompactConversation(customInstructions)`.

### Connector Implementation

1.  **Connector Method** (`src/main/connector.ts`):
    - Create a new public method `sendCompactConversation(customInstructions?: string)`.
    - This method will construct and send a `CompactConversationMessage`.
    - `const message: CompactConversationMessage = { action: 'compact-conversation', customInstructions };`
    - `this.sendMessage(message);`

2.  **Message Type** (`src/main/messages.ts`):
    - Define the `CompactConversationMessage` interface.
    - `export interface CompactConversationMessage extends Message { action: 'compact-conversation'; customInstructions?: string; }`

3.  **Python Handler** (`resources/connector/connector.py`):
    - In the `handle_message` function (or equivalent message handler), add a case for the `'compact-conversation'` action.
    - When this action is received, the Python connector should trigger Aider's internal summarization capabilities, passing the `customInstructions` if available. This may require adding a new method to the `Coder` class in Aider itself or using an existing command. The result should be that Aider's internal conversation history is replaced by the summary.

## Success Criteria
1.  User can type `/compact` or `/compact with custom instructions` into the prompt field.
2.  A "Compacting conversation..." log message appears in the chat.
3.  In 'agent' mode, the conversation is replaced by a summary generated by the agent.
4.  In 'code' mode, the conversation in the Python backend is summarized.
5.  The `customInstructions` are used to guide the summarization in both modes.
6.  The UI updates to show the new, compacted conversation history.
